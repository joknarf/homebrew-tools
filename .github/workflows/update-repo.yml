name: Update Homebrew Index

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches:
      - main
    paths:
      - 'Formula/*.rb'

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Generate dark-mode index.html
      run: |
        echo "<html><head><title>Joknarf Tools Homebrew Tap</title><style>
        :root { color-scheme: light dark; }
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
               'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
               margin: 2rem; background: #ffffff; color: #111111; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f5f5f5; text-align: left; }
        a { color: #0969da; text-decoration: none; }
        a:hover { text-decoration: underline; }
        @media (prefers-color-scheme: dark) {
          body { background: #0d1117; color: #c9d1d9; }
          table, th, td { border-color: #30363d; }
          th { background-color: #161b22; }
          a { color: #58a6ff; }
        }
        </style></head><body>" > index.html

        echo "<h1>Joknarf Tools Homebrew Tap</h1>" >> index.html
        echo "<table>" >> index.html
        echo "<tr><th>Formula</th><th>Version</th><th>Description</th><th>URL</th></tr>" >> index.html

        for f in Formula/*.rb; do
            # Extract basic info from the formula using Ruby
            read -r name version desc url <<< $(ruby -r "./$f" -e "
              f = $(File.basename f, '.rb').split.map(&:join).first
              formula = Object.const_get(f)
              puts [formula.name, formula.version, formula.desc, formula.homepage].map{|x| x.to_s.shellescape}.join(' ')
            ")

            echo "<tr>
              <td><a href=\"$f\">$name</a></td>
              <td>$version</td>
              <td>$desc</td>
              <td><a href=\"$url\">$url</a></td>
            </tr>" >> index.html
        done

        echo "</table></body></html>" >> index.html

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add index.html
        git diff --quiet && git diff --staged --quiet || \
          git commit -m "Update Homebrew index.html"
        git push

    - uses: actions/configure-pages@v5
    - uses: actions/upload-pages-artifact@v3
      with:
        path: .

