name: Update Homebrew Index

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches:
      - main
    paths:
      - 'Formula/*.rb'

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Generate Homebrew metadata JSON
      run: |
        brew info --json=v2 --formula ./Formula/*.rb > formulas.json

    - name: Generate index.html
      run: |
        set -euo pipefail

        brew info --json=v2 --formula ./Formula/*.rb > formulas.json

        cat > index.html <<'EOF'
        <html>
        <head>
            <title>Joknarf Homebrew Tap</title>
            <style>
                :root { color-scheme: light dark; }
                body {
                    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                                 "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    margin: 2rem;
                }
                table {
                    border-collapse: collapse;
                    width: 100%;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    vertical-align: top;
                }
                th {
                    background-color: #f5f5f5;
                    text-align: left;
                }
                a {
                    color: #0969da;
                    text-decoration: none;
                }
                a:hover {
                    text-decoration: underline;
                }
                @media (prefers-color-scheme: dark) {
                    body { background: #0d1117; color: #c9d1d9; }
                    table, th, td { border-color: #30363d; }
                    th { background-color: #161b22; }
                    a { color: #58a6ff; }
                }
            </style>
        </head>
        <body>
            <h1>Joknarf Homebrew Tap</h1>
            <table>
                <tr>
                    <th>Formula</th>
                    <th>Version</th>
                    <th>Description</th>
                    <th>Bottles</th>
                </tr>
        EOF

        jq -r '
            .formulae[] |
            "<tr>" +
                "<td><a href=\"Formula/\(.name).rb\">\(.name)</a></td>" +
                "<td>\(.versions.stable // "head")</td>" +
                "<td>\(.desc // "")</td>" +
                "<td>" +
                    (
                        .bottle.stable.files
                        | to_entries
                        | map(.key)
                        | sort
                        | join(", ")
                    ) +
                "</td>" +
            "</tr>"
        ' formulas.json >> index.html

        cat >> index.html <<'EOF'
            </table>
        </body>
        </html>
        EOF

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add index.html
        git diff --quiet && git diff --staged --quiet || \
          git commit -m "Update Homebrew index.html"
        git push

    - uses: actions/configure-pages@v5
    - uses: actions/upload-pages-artifact@v3
      with:
        path: .
    - uses: actions/deploy-pages@v4
